package cn.jqe.hive;
import org.apache.hadoop.hive.ql.exec.UDAF;
import org.apache.hadoop.hive.ql.exec.UDAFEvaluator;
//定义Java类hiveUDAF，并继承UDAF类
public class hiveUDAF extends UDAF {
	//定义静态内部类AvgState
	public static class AvgState {
		//定义两个变量，用于存放元素数量和元素之和
		private long mCount;
		private double mSum;
	}
	//定义静态内部类AvgEvaluator，实现UDAFEvaluator接口
	public static class AvgEvaluator implements UDAFEvaluator {
		//定义一个AvgState类型的变量state，用于保存聚合状态
		AvgState state;
		//构造方法，在创建AvgEvaluator实例时初始化state
		public AvgEvaluator() {
			super();
			state = new AvgState();
			init();
		}
		//重写init()方法
		public void init() {
			state.mSum = 0;
			state.mCount = 0;
		}
		//重写iterate()方法
		public boolean iterate(Double i) {
			if (i != null) {
				state.mSum += i;
				state.mCount++;
			}
			return true;
		}
		//重写terminatePartial()方法
		public AvgState terminatePartial() {
			return state.mCount == 0 ? null : state;
		}
		//重写merge()方法，该方法接收terminatePartial()方法的返回结果
		public boolean merge(AvgState avgState) {
			if (avgState != null) {
				state.mCount += avgState.mCount;
				state.mSum += avgState.mSum;
			}
			return true;
		}
		//重写terminate()方法
		public Double terminate() {
			return state.mCount == 0 ? null : Double.valueOf(state.mSum / state.mCount);
		}
	}
}
